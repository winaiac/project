<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ศูนย์ควบคุมภารกิจ RESP-01 (Mission Control)</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&family=Rajdhani:wght@500;700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Sarabun', sans-serif;
            background: black;
            color: white;
            user-select: none;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
        }

        .header {
            text-align: center;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(8px);
            padding: 10px 30px;
            border-radius: 0 0 20px 20px;
            pointer-events: auto;
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-top: none;
            display: inline-block;
            margin: 0 auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 10px 30px -10px rgba(56, 189, 248, 0.5);
            z-index: 10;
        }

        h1 {
            margin: 0;
            font-family: 'Sarabun', sans-serif;
            font-weight: 700;
            font-size: 20px;
            background: linear-gradient(90deg, #38bdf8, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .sub-header {
            font-size: 12px;
            color: #94a3b8;
            font-family: 'Rajdhani', sans-serif;
            letter-spacing: 1px;
        }

        .panels-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 80px;
            height: 100%;
            padding-bottom: 50px;
            pointer-events: none;
        }

        .panel-box {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid #334155;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            width: 320px;
            /* Wider for bilingual text */
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            border-bottom: 1px dashed #334155;
            padding-bottom: 5px;
        }

        .status-val {
            font-family: 'Rajdhani', monospace;
            font-weight: bold;
            color: #38bdf8;
            font-size: 16px;
        }

        .status-label {
            color: #cbd5e1;
            font-size: 12px;
        }

        /* Controls */
        .slider-container {
            margin-top: 5px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #334155;
            transition: all 0.3s;
        }

        input[type=range] {
            width: 100%;
            margin: 10px 0;
            accent-color: #eab308;
            cursor: pointer;
        }

        .angle-display {
            text-align: center;
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            color: #eab308;
            font-weight: bold;
        }

        .btn-main {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
            font-family: 'Sarabun', sans-serif;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            line-height: 1.2;
        }

        .btn-launch {
            background: linear-gradient(90deg, #dc2626, #991b1b);
            color: white;
        }

        .btn-deploy {
            background: linear-gradient(90deg, #eab308, #ca8a04);
            color: black;
        }

        .btn-orbit {
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .btn-reset {
            background: #475569;
            color: white;
            margin-top: auto;
        }

        .btn-main:hover {
            filter: brightness(1.2);
            transform: translateY(-1px);
        }

        .btn-main:disabled {
            filter: grayscale(1);
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .btn-small {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid #475569;
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            transition: 0.2s;
        }

        .btn-small.active {
            background: #0ea5e9;
            color: white;
            border-color: #38bdf8;
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.4);
        }

        .btn-auto {
            background: #334155;
            color: white;
        }

        .btn-auto.active {
            background: linear-gradient(90deg, #10b981, #059669);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
            border: none;
        }

        /* HUD Overlay */
        .hud-center {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            pointer-events: none;
            width: 100%;
        }

        .message-log {
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            color: #38bdf8;
            border: 1px solid #38bdf8;
            display: inline-block;
            margin-bottom: 10px;
            backdrop-filter: blur(4px);
            max-width: 80%;
        }

        .thrust-meter {
            width: 100%;
            height: 10px;
            background: #1e293b;
            border-radius: 5px;
            margin: 0 auto;
            overflow: hidden;
            border: 1px solid #475569;
        }

        .thrust-bar {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #84cc16);
            width: 0%;
            transition: width 0.2s;
        }

        /* Moon Cam Button */
        .cam-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #38bdf8;
            color: #38bdf8;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            pointer-events: auto;
            display: none;
            font-family: 'Sarabun', sans-serif;
            font-weight: bold;
            z-index: 20;
        }

        .cam-btn:hover {
            background: rgba(56, 189, 248, 0.2);
        }

        .en-text {
            font-size: 10px;
            opacity: 0.7;
            display: block;
        }
    </style>
    <!-- Three.js Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.146.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/controls/OrbitControls.js"></script>
</head>

<body>

    <div id="ui-layer">
        <div class="header">
            <h1>ศูนย์ควบคุมภารกิจ RESP-01<br><span style="font-size: 16px;">Mission Control Center</span></h1>
            <div class="sub-header">ROI-ET SPACE PROGRAM</div>
        </div>

        <button id="btn-moon-cam" class="cam-btn" onclick="toggleMoonCam()">
            <i class="fas fa-video mr-2"></i> กล้องดวงจันทร์<br><span class="en-text">Moon Camera</span>
        </button>

        <div class="panels-container">
            <!-- Left Panel: Sequence -->
            <div class="panel-box" style="margin-left: 20px;">
                <h3 class="text-white font-bold border-b border-gray-600 pb-2 mb-2">
                    <i class="fas fa-rocket mr-2"></i>ลำดับภารกิจ <span
                        style="font-size: 12px; color: #94a3b8;">(Sequence)</span>
                </h3>

                <div id="step1" class="p-2 rounded bg-slate-800 text-gray-400 text-sm mb-1">
                    <i class="fas fa-circle text-[8px] mr-2"></i>1. ปล่อยสู่วงโคจร GTO<br><span
                        class="en-text ml-4">Launch to GTO</span>
                </div>
                <div id="step2" class="p-2 rounded bg-slate-800 text-gray-400 text-sm mb-1">
                    <i class="fas fa-circle text-[8px] mr-2"></i>2. กางใบเรือสุริยะ<br><span class="en-text ml-4">Deploy
                        Solar Sail</span>
                </div>
                <div id="step3" class="p-2 rounded bg-slate-800 text-gray-400 text-sm mb-1">
                    <i class="fas fa-circle text-[8px] mr-2"></i>3. เดินทางด้วยแสงอาทิตย์<br><span
                        class="en-text ml-4">Solar Sailing Cruise</span>
                </div>
                <div id="step4" class="p-2 rounded bg-slate-800 text-gray-400 text-sm mb-1">
                    <i class="fas fa-circle text-[8px] mr-2"></i>4. เข้าวงโคจรดวงจันทร์<br><span
                        class="en-text ml-4">Lunar Orbit Insertion</span>
                </div>

                <button id="btn-action" class="btn-main btn-launch mt-2" onclick="handleAction()">
                    <div><i class="fas fa-fire"></i> ปล่อยจรวด<br><span class="en-text">Launch Rocket</span></div>
                </button>

                <div class="mt-4 mb-1 text-xs text-gray-400">ระบบควบคุม (CONTROL)</div>
                <div class="flex gap-2 mb-2">
                    <button id="btn-auto" class="btn-small btn-auto w-full flex items-center justify-center gap-2"
                        onclick="toggleAutoPilot()">
                        <div><i class="fas fa-robot"></i> ระบบอัตโนมัติ (AI)<br><span class="en-text">Auto-Pilot</span>
                        </div>
                    </button>
                </div>

                <div class="text-xs text-gray-400 mt-2">เร่งเวลาจำลอง (TIME WARP)</div>
                <div class="btn-group">
                    <button class="btn-small active" onclick="setTimeWarp(1, this)">1x</button>
                    <button class="btn-small" onclick="setTimeWarp(5, this)">5x</button>
                    <button class="btn-small" onclick="setTimeWarp(20, this)">20x</button>
                </div>

                <div class="slider-container" id="control-panel" style="opacity: 0.5; pointer-events: none;">
                    <div class="text-xs text-yellow-500 mb-1 uppercase font-bold flex justify-between">
                        <span>มุมใบเรือ (Pitch Angle)</span>
                        <span id="auto-badge"
                            class="hidden text-[10px] bg-green-500 text-black px-1 rounded">AUTO</span>
                    </div>
                    <input type="range" id="sail-slider" min="-90" max="90" value="0" step="1">
                    <div class="angle-display"><span id="angle-val">0</span>°</div>
                    <div class="text-[10px] text-gray-400 text-center mt-1">
                        ปรับมุมเพื่อรับแรงผลักสูงสุด<br><span class="en-text">Adjust angle for max thrust</span>
                    </div>
                </div>

                <button class="btn-main btn-reset" onclick="resetSim()">
                    <div><i class="fas fa-redo"></i> รีเซ็ตภารกิจ<br><span class="en-text">Reset Mission</span></div>
                </button>
            </div>

            <!-- Right Panel: Telemetry -->
            <div class="panel-box" style="margin-right: 20px;">
                <h3 class="text-white font-bold border-b border-gray-600 pb-2 mb-2">
                    <i class="fas fa-chart-line mr-2"></i>ข้อมูลการบิน <span
                        style="font-size: 12px; color: #94a3b8;">(Telemetry)</span>
                </h3>

                <div class="status-item">
                    <span class="status-label">ระยะห่างจากโลก<br><span class="en-text">Distance from Earth</span></span>
                    <span class="status-val" id="val-dist">0 km</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ระยะห่างจากดวงจันทร์<br><span class="en-text">Distance to
                            Moon</span></span>
                    <span class="status-val" id="val-moon-dist">384,400 km</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ความเร็ววงโคจร<br><span class="en-text">Orbital Velocity</span></span>
                    <span class="status-val" id="val-vel">0 km/h</span>
                </div>
                <div class="status-item">
                    <span class="status-label">แรงขับดันแสง (Thrust)<br><span class="en-text">Solar Radiation
                            Pressure</span></span>
                    <span class="status-val" id="val-thrust" style="color: #eab308">0.00 mN</span>
                </div>

                <div class="mt-4 border-t border-gray-700 pt-2">
                    <div class="text-xs text-gray-400 mb-1">ประสิทธิภาพแรงขับ (Efficiency)</div>
                    <div class="thrust-meter">
                        <div class="thrust-bar" id="thrust-bar"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="hud-center">
            <div class="message-log" id="msg-log">
                <div>ระบบพร้อม... เตรียมปล่อยยาน<br><span class="en-text">System Ready... Awaiting Launch</span></div>
            </div>
            <div class="text-[12px] text-gray-400 mt-2">
                คลิกซ้าย: หมุนกล้อง | ลูกกลิ้ง: ซูมเข้า-ออก<br>
                <span class="en-text">Left Click: Rotate | Scroll: Zoom</span>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS & PHYSICS ---
        const R_EARTH = 63.71; // Visual Scale 1 unit = 100km
        const R_MOON = 17.37;
        const D_MOON = 3844; // 384,400km scaled
        const D_GTO = 400;   // ~36,000km scaled visual

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000); // อวกาศสีดำสนิท
        scene.fog = new THREE.FogExp2(0x000000, 0.00005);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 50000);
        camera.position.set(0, 300, 800);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.physicallyCorrectLights = true;
        renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.minDistance = 50;
        controls.maxDistance = 10000;

        // --- CELESTIAL BODIES ---
        const loader = new THREE.TextureLoader();

        // 1. EARTH (โลก) - IMPROVED TEXTURE & MATERIAL
        const earthGroup = new THREE.Group();
        const earthMesh = new THREE.Mesh(
            new THREE.SphereGeometry(R_EARTH, 64, 64),
            new THREE.MeshPhongMaterial({
                map: loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_2048.jpg'),
                specular: new THREE.Color(0x333333),
                shininess: 5,
                color: 0xffffff
            })
        );
        earthGroup.add(earthMesh);

        // Atmosphere
        const atmos = new THREE.Mesh(
            new THREE.SphereGeometry(R_EARTH * 1.03, 64, 64),
            new THREE.MeshBasicMaterial({
                color: 0x3b82f6,
                transparent: true,
                opacity: 0.15,
                side: THREE.BackSide,
                blending: THREE.AdditiveBlending
            })
        );
        earthGroup.add(atmos);
        scene.add(earthGroup);

        // 2. SUN (ดวงอาทิตย์)
        const sunDist = 8000;
        const sunGroup = new THREE.Group();
        sunGroup.position.set(-sunDist, 0, 0);

        const sunMesh = new THREE.Mesh(
            new THREE.SphereGeometry(200, 32, 32),
            new THREE.MeshBasicMaterial({ color: 0xffffaa })
        );
        sunGroup.add(sunMesh);

        const spriteMat = new THREE.SpriteMaterial({
            map: loader.load('https://threejs.org/examples/textures/sprites/glow.png'),
            color: 0xffaa00,
            transparent: true,
            blending: THREE.AdditiveBlending
        });
        const sunGlow = new THREE.Sprite(spriteMat);
        sunGlow.scale.set(3000, 3000, 1);
        sunGroup.add(sunGlow);
        scene.add(sunGroup);

        // Lighting (ระบบแสง) - ปรับปรุงให้โลกสว่างขึ้น
        const sunLight = new THREE.DirectionalLight(0xffffff, 2.0);
        sunLight.position.set(-1, 0, 0);
        scene.add(sunLight);

        // เพิ่ม Ambient Light ให้สว่างขึ้น เพื่อแก้ปัญหาโลกด้านเงาเป็นสีดำสนิท/เทา
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const hemiLight = new THREE.HemisphereLight(0x0000ff, 0x000000, 0.2);
        scene.add(hemiLight);

        // 3. MOON (ดวงจันทร์)
        const moonGroup = new THREE.Group();
        moonGroup.position.set(D_MOON, 0, 0);
        const moonMesh = new THREE.Mesh(
            new THREE.SphereGeometry(R_MOON, 32, 32),
            new THREE.MeshStandardMaterial({
                map: loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/moon_1024.jpg'),
                roughness: 0.9,
                metalness: 0
            })
        );
        moonGroup.add(moonMesh);
        scene.add(moonGroup);

        // Stars
        const starsGeo = new THREE.BufferGeometry();
        const starsPos = [];
        for (let i = 0; i < 5000; i++) {
            starsPos.push((Math.random() - 0.5) * 30000, (Math.random() - 0.5) * 30000, (Math.random() - 0.5) * 30000);
        }
        starsGeo.setAttribute('position', new THREE.Float32BufferAttribute(starsPos, 3));
        const stars = new THREE.Points(starsGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 1.5, transparent: true, opacity: 0.8 }));
        scene.add(stars);

        // --- SPACECRAFT RESP-01 ---
        const shipContainer = new THREE.Group();
        scene.add(shipContainer);

        const bus = new THREE.Mesh(
            new THREE.BoxGeometry(2, 2, 2),
            new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.3, metalness: 0.8 })
        );
        shipContainer.add(bus);

        const sailPivot = new THREE.Group();
        shipContainer.add(sailPivot);

        // Sail Mesh - RESIZED (Smaller)
        // ลดขนาดจาก 60 เป็น 25 เพื่อให้ดูสมจริงขึ้นเมื่อเทียบกับหน้าจอ
        const sailGeo = new THREE.PlaneGeometry(25, 25);
        const sailMat = new THREE.MeshStandardMaterial({
            color: 0xffd700,
            side: THREE.DoubleSide,
            metalness: 1.0,
            roughness: 0.2,
            emissive: 0x221100,
            transparent: true,
            opacity: 0.95
        });
        const sail = new THREE.Mesh(sailGeo, sailMat);
        sail.rotation.y = -Math.PI / 2;
        sailPivot.add(sail);

        // Booms (ย่อขนาดตามใบเรือ)
        const boomMat = new THREE.MeshBasicMaterial({ color: 0x333333 });
        const boom1 = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 35), boomMat); // ลดความยาว
        boom1.rotation.z = Math.PI / 4; boom1.rotation.y = -Math.PI / 2;
        sailPivot.add(boom1);
        const boom2 = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 35), boomMat); // ลดความยาว
        boom2.rotation.z = -Math.PI / 4; boom2.rotation.y = -Math.PI / 2;
        sailPivot.add(boom2);

        sailPivot.visible = false;

        const arrowDir = new THREE.Vector3(1, 0, 0);
        const arrowOrigin = new THREE.Vector3(0, 0, 0);
        const arrowHelper = new THREE.ArrowHelper(arrowDir, arrowOrigin, 20, 0x00ff00, 5, 3);
        shipContainer.add(arrowHelper);
        arrowHelper.visible = false;

        // --- VARS ---
        let phase = 0;
        let distance = R_EARTH + 1;
        let angle = 0;
        let moonOrbitAngle = 0;
        let userAngle = 0;
        let thrustEfficiency = 0;
        let launchTime = 0;
        let timeWarp = 1;
        let isAutoPilot = false;
        let moonCamActive = false;

        const trailPoints = [];
        const trailGeo = new THREE.BufferGeometry();
        const trailMat = new THREE.LineBasicMaterial({ color: 0x38bdf8 });
        const trailLine = new THREE.Line(trailGeo, trailMat);
        scene.add(trailLine);

        // UI Refs
        const btnAction = document.getElementById('btn-action');
        const msgLog = document.getElementById('msg-log');
        const slider = document.getElementById('sail-slider');
        const angleDisplay = document.getElementById('angle-val');
        const controlPanel = document.getElementById('control-panel');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const valDist = document.getElementById('val-dist');
        const valMoon = document.getElementById('val-moon-dist');
        const valVel = document.getElementById('val-vel');
        const valThrust = document.getElementById('val-thrust');
        const thrustBar = document.getElementById('thrust-bar');
        const btnAuto = document.getElementById('btn-auto');
        const autoBadge = document.getElementById('auto-badge');
        const btnMoonCam = document.getElementById('btn-moon-cam');

        // --- LOGIC ---
        slider.addEventListener('input', (e) => {
            if (isAutoPilot) return;
            updateSailAngle(parseInt(e.target.value));
        });

        function updateSailAngle(val) {
            userAngle = val;
            angleDisplay.innerText = userAngle;
            slider.value = userAngle;
            sailPivot.rotation.z = THREE.MathUtils.degToRad(userAngle);
        }

        function toggleAutoPilot() {
            isAutoPilot = !isAutoPilot;
            if (isAutoPilot) {
                btnAuto.classList.add('active');
                autoBadge.classList.remove('hidden');
                slider.disabled = true;
                slider.classList.add('opacity-50', 'cursor-not-allowed');
                msgLog.innerHTML = "<div>เปิดระบบขับเคลื่อนอัตโนมัติ (AI Navigation)<br><span class='en-text'>Auto-Pilot Engaged: Optimizing Trajectory</span></div>";
                msgLog.style.color = "#10b981";
            } else {
                btnAuto.classList.remove('active');
                autoBadge.classList.add('hidden');
                slider.disabled = false;
                slider.classList.remove('opacity-50', 'cursor-not-allowed');
                msgLog.innerHTML = "<div>เปลี่ยนเป็นระบบควบคุมด้วยมือ (Manual Control)<br><span class='en-text'>Manual Control Engaged</span></div>";
                msgLog.style.color = "#fbbf24";
            }
        }

        function toggleMoonCam() {
            moonCamActive = !moonCamActive;
            if (moonCamActive) {
                btnMoonCam.style.background = "#38bdf8";
                btnMoonCam.style.color = "black";
                msgLog.innerHTML = "<div>มุมกล้อง: วงโคจรดวงจันทร์<br><span class='en-text'>Camera: Lunar Orbit View</span></div>";
            } else {
                btnMoonCam.style.background = "rgba(0,0,0,0.6)";
                btnMoonCam.style.color = "#38bdf8";
                msgLog.innerHTML = "<div>มุมกล้อง: ภาพรวมภารกิจ<br><span class='en-text'>Camera: Mission Overview</span></div>";
                controls.target.set(0, 0, 0);
                camera.position.set(0, 300, 800);
            }
        }

        function setTimeWarp(factor, btn) {
            timeWarp = factor;
            document.querySelectorAll('.btn-group button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            msgLog.innerHTML = `<div>เร่งเวลาจำลอง: ${factor}x<br><span class='en-text'>Time Warp: ${factor}x speed</span></div>`;
        }

        function handleAction() {
            if (phase === 0) {
                // LAUNCH
                phase = 1;
                btnAction.innerHTML = '<div><i class="fas fa-spinner fa-spin"></i> กำลังปล่อยยาน...<br><span class="en-text">Launching...</span></div>';
                btnAction.disabled = true;
                msgLog.innerHTML = "<div>ปล่อยยาน! จุดระเบิดบูสเตอร์มุ่งสู่ GTO<br><span class='en-text'>Liftoff! Booster ignition to GTO</span></div>";
                msgLog.style.color = "#fbbf24";
                step1.classList.add('text-white', 'font-bold', 'bg-blue-900');
                launchTime = Date.now();

            } else if (phase === 2) {
                // DEPLOY
                msgLog.innerHTML = "<div>กำลังสั่งการกางใบเรือสุริยะ...<br><span class='en-text'>Deploying Solar Sail...</span></div>";
                sailPivot.visible = true;
                sailPivot.scale.set(0.01, 0.01, 0.01);

                let s = 0;
                let deployInt = setInterval(() => {
                    s += 0.05;
                    sailPivot.scale.set(s, s, s);
                    if (s >= 1) {
                        clearInterval(deployInt);
                        phase = 3;
                        msgLog.innerHTML = "<div>กางใบเรือสมบูรณ์ ระบบควบคุมพร้อมทำงาน<br><span class='en-text'>Sail Deployed. Control System Online.</span></div>";
                        msgLog.style.color = "#34d399";
                        btnAction.innerHTML = "<div>กำลังเดินทางสู่ดวงจันทร์<br><span class='en-text'>En Route to Moon</span></div>";
                        step3.classList.add('text-white', 'font-bold', 'bg-blue-900');

                        controlPanel.style.opacity = 1;
                        controlPanel.style.pointerEvents = 'auto';
                        arrowHelper.visible = true;
                    }
                }, 50);
            }
        }

        function resetSim() {
            phase = 0;
            distance = R_EARTH + 1;
            angle = 0;
            moonOrbitAngle = 0;
            trailPoints.length = 0;
            trailGeo.setFromPoints([]);
            shipContainer.position.set(distance, 0, 0);
            sailPivot.visible = false;
            arrowHelper.visible = false;
            controlPanel.style.opacity = 0.5;
            controlPanel.style.pointerEvents = 'none';
            btnAction.disabled = false;
            btnAction.innerHTML = '<div><i class="fas fa-fire"></i> ปล่อยจรวด<br><span class="en-text">Launch Rocket</span></div>';
            btnAction.className = "btn-main btn-launch";
            msgLog.innerHTML = "<div>ระบบพร้อม... เตรียมปล่อยยาน<br><span class='en-text'>System Ready... Awaiting Launch</span></div>";
            msgLog.style.color = "#38bdf8";

            step1.className = "p-2 rounded bg-slate-800 text-gray-400 text-sm mb-1";
            step2.className = "p-2 rounded bg-slate-800 text-gray-400 text-sm mb-1";
            step3.className = "p-2 rounded bg-slate-800 text-gray-400 text-sm mb-1";
            step4.className = "p-2 rounded bg-slate-800 text-gray-400 text-sm mb-1";

            camera.position.set(0, 300, 800);
            controls.target.set(0, 0, 0);

            isAutoPilot = false;
            btnAuto.classList.remove('active');
            autoBadge.classList.add('hidden');
            slider.disabled = false;
            slider.classList.remove('opacity-50', 'cursor-not-allowed');
            updateSailAngle(0);

            moonCamActive = false;
            btnMoonCam.style.display = 'none';
        }

        function animate() {
            requestAnimationFrame(animate);

            earthGroup.rotation.y += 0.0005;

            if (phase === 1) { // GTO Launch
                let timeDelta = (Date.now() - launchTime) / 2000;
                if (timeDelta < 1) timeDelta = 1;

                angle += 0.015 * timeWarp;

                let progress = Math.min(1, angle / Math.PI);
                let targetDist = R_EARTH + (D_GTO - R_EARTH) * progress;
                distance = targetDist;

                if (distance >= D_GTO * 0.95 && btnAction.disabled) {
                    phase = 2; // Ready to deploy
                    btnAction.disabled = false;
                    btnAction.className = "btn-main btn-deploy";
                    btnAction.innerHTML = '<div><i class="fas fa-satellite"></i> กางใบเรือ<br><span class="en-text">Deploy Sail</span></div>';
                    msgLog.innerHTML = "<div>ถึงจุดสูงสุด (Apogee 36,000 กม.) เตรียมกางใบ<br><span class='en-text'>Apogee Reached. Ready to Deploy.</span></div>";
                    msgLog.style.color = "#eab308";
                    step2.classList.add('text-white', 'font-bold', 'bg-blue-900');

                    angle -= 0.015 * timeWarp;
                }

                shipContainer.position.x = Math.cos(angle) * distance;
                shipContainer.position.z = Math.sin(angle) * distance;
            }
            else if (phase === 3) { // Solar Sailing

                if (isAutoPilot) {
                    updateSailAngle(0);
                }

                let rad = THREE.MathUtils.degToRad(userAngle);
                let incidence = Math.cos(rad);
                let thrustMag = Math.max(0, incidence * incidence);

                thrustEfficiency = thrustMag * 100;
                thrustBar.style.width = thrustEfficiency + "%";
                valThrust.innerText = (thrustMag * 9.2).toFixed(2) + " mN";

                arrowHelper.setDirection(new THREE.Vector3(Math.cos(rad), 0, Math.sin(rad)).normalize());
                arrowHelper.setLength(20 * thrustMag + 5);

                let orbitSpeed = (400 / distance) * timeWarp;
                angle += orbitSpeed * 0.01;

                let growth = thrustMag * 0.5 * timeWarp;
                if (isAutoPilot) growth *= 1.2;

                distance += growth;

                shipContainer.position.x = Math.cos(angle) * distance;
                shipContainer.position.z = Math.sin(angle) * distance;

                if (!moonCamActive) {
                    let targetPos = shipContainer.position.clone();
                    controls.target.lerp(targetPos, 0.05);
                    camera.position.x += (shipContainer.position.x - camera.position.x) * 0.01;
                }

                if (distance >= D_MOON - R_MOON - 10) {
                    msgLog.innerHTML = "<div>เข้าสู่แรงดึงดูดดวงจันทร์สำเร็จ! เริ่มวงโคจร<br><span class='en-text'>Lunar Capture Successful! Entering Orbit.</span></div>";
                    msgLog.style.color = "#00ff00";
                    msgLog.style.fontWeight = "bold";
                    phase = 4;
                    step4.classList.add('text-white', 'font-bold', 'bg-blue-900');
                    btnAction.innerHTML = "<div>ภารกิจสำเร็จ<br><span class='en-text'>Mission Accomplished</span></div>";
                    btnAction.className = "btn-main btn-orbit";

                    btnMoonCam.style.display = 'block';
                    toggleMoonCam();
                }
            }
            else if (phase === 4) {
                // Lunar Orbit
                moonOrbitAngle += 0.02 * timeWarp;
                let orbitRadius = 60;

                shipContainer.position.x = D_MOON + Math.cos(moonOrbitAngle) * orbitRadius;
                shipContainer.position.z = Math.sin(moonOrbitAngle) * orbitRadius;

                shipContainer.lookAt(D_MOON, 0, 0);
                sailPivot.rotation.z += 0.01;

                if (moonCamActive) {
                    controls.target.set(D_MOON, 0, 0);
                    camera.position.x = D_MOON + Math.cos(moonOrbitAngle - 0.5) * 150;
                    camera.position.z = Math.sin(moonOrbitAngle - 0.5) * 150;
                    camera.position.y = 50;
                }
            }

            if (phase < 4) {
                shipContainer.lookAt(-10000, 0, 0);
            }

            if (phase > 0 && frameCount % 5 === 0) {
                if (phase < 4) {
                    trailPoints.push(shipContainer.position.clone());
                    if (trailPoints.length > 500) trailPoints.shift();
                    trailGeo.setFromPoints(trailPoints);
                }
            }

            updateHUD();

            controls.update();
            renderer.render(scene, camera);
            frameCount++;
        }

        let frameCount = 0;

        function updateHUD() {
            let realDist = (distance * 100) - 6371;
            if (realDist < 0) realDist = 0;
            valDist.innerText = realDist.toLocaleString('en-US', { maximumFractionDigits: 0 }) + " km";

            let moonDist = 384400 - realDist;
            if (moonDist < 0) moonDist = 0;

            if (phase === 4) {
                valMoon.innerHTML = "อยู่ในวงโคจร <span style='font-size:10px'>(ORBITING)</span>";
                valMoon.style.color = "#00ff00";
            } else {
                valMoon.innerText = moonDist.toLocaleString('en-US', { maximumFractionDigits: 0 }) + " km";
                valMoon.style.color = "#38bdf8";
            }

            let v = 28000 / Math.sqrt(distance / R_EARTH);
            valVel.innerText = v.toLocaleString('en-US', { maximumFractionDigits: 0 }) + " km/h";
        }

        resetSim();
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>

</html>