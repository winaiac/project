<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winai Audio Equalizer - Stereo Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Orbitron:wght@500;700&display=swap"
        rel="stylesheet">
    <style>
        /* --- CORE STYLES --- */
        body {
            font-family: 'Kanit', sans-serif;
            background-color: transparent;
            color: #d1d5db;
            overflow: hidden;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #0f0f0f;
            background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #050505 100%);
            -webkit-app-region: drag;
            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏ö‡∏ô‡∏à‡∏≠‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™ */
            -webkit-user-select: none;
            user-select: none;
        }

        /* --- THEME DEFINITIONS --- */
        .retro-casing {
            position: relative;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: inset 0 0 60px rgba(0, 0, 0, 0.5), 0 30px 80px rgba(0, 0, 0, 1), 0 0 0 2px #000;
            transition: all 0.5s ease;
            width: 1100px;
            flex-shrink: 0;
            margin: 0;
            -webkit-app-region: drag;
        }

        /* FIX: Elements that MUST be clickable (Not draggable) */
        button,
        input,
        canvas,
        iframe,
        .theme-btn,
        a,
        .credit-link,
        .playlist-item,
        .playlist-controls,
        .relink-btn,
        .preset-btn-side {
            -webkit-app-region: no-drag;
            cursor: pointer;
            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡∏∞‡∏ã‡πâ‡∏≥‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏¢‡∏≤‡∏¢‡∏à‡∏≠‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            touch-action: manipulation;
        }

        .faceplate {
            -webkit-app-region: drag;
        }

        /* Themes */
        .theme-wood {
            background-color: #3e2723;
            background-image: linear-gradient(rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0) 20%), repeating-linear-gradient(90deg, rgba(0, 0, 0, 0.05) 0px, rgba(0, 0, 0, 0.05) 2px, transparent 2px, transparent 4px), linear-gradient(to bottom, #5D4037 0%, #3E2723 40%, #281812 100%);
            border-top: 1px solid #795548;
            border-bottom: 8px solid #150b08;
        }

        .theme-metal {
            background-color: #cfd8dc;
            background-image: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(0, 0, 0, 0.1) 100%), repeating-linear-gradient(0deg, transparent, transparent 2px, #9ca3af 2px, #9ca3af 3px);
            border-top: 2px solid #fff;
            border-bottom: 8px solid #546e7a;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3), 0 30px 60px rgba(0, 0, 0, 0.9);
        }

        .theme-black {
            background-color: #111;
            background-image: radial-gradient(circle, #222 1px, transparent 1px);
            background-size: 4px 4px;
            border-top: 1px solid #444;
            border-bottom: 8px solid #000;
        }

        .theme-pink {
            background-color: #f8bbd0;
            background-image: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.05) 100%), repeating-linear-gradient(0deg, transparent, transparent 2px, #f48fb1 2px, #f48fb1 3px);
            border-top: 2px solid #ffebee;
            border-bottom: 8px solid #c2185b;
        }

        /* Screws */
        .screw {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            -webkit-app-region: drag;
        }

        .screw::after {
            content: '';
            width: 10px;
            height: 2px;
            transform: rotate(45deg);
            box-shadow: inset 1px 1px 1px rgba(0, 0, 0, 0.5);
        }

        .theme-wood .screw {
            background: radial-gradient(circle at 30% 30%, #fcd34d, #b45309);
        }

        .theme-wood .screw::after {
            background: #78350f;
        }

        .theme-metal .screw {
            background: radial-gradient(circle at 30% 30%, #ffffff, #64748b);
        }

        .theme-metal .screw::after {
            background: #334155;
        }

        .theme-metal h1 {
            color: #374151 !important;
            text-shadow: 1px 1px 0 #fff !important;
        }

        .theme-metal .text-amber-600 {
            color: #b91c1c !important;
        }

        .theme-black .screw {
            background: radial-gradient(circle at 30% 30%, #444, #000);
            box-shadow: 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .theme-black .screw::after {
            background: #000;
            box-shadow: 0 0 1px rgba(255, 255, 255, 0.2);
        }

        .theme-pink .screw {
            background: radial-gradient(circle at 30% 30%, #fff, #ec407a);
        }

        .theme-pink .screw::after {
            background: #880e4f;
        }

        .theme-pink h1 {
            color: #880e4f !important;
            text-shadow: 1px 1px 0 #fff !important;
        }

        .theme-pink .text-amber-600 {
            color: #c2185b !important;
        }

        .screw.tl {
            top: 12px;
            left: 12px;
        }

        .screw.tr {
            top: 12px;
            right: 12px;
        }

        .screw.bl {
            bottom: 12px;
            left: 12px;
        }

        .screw.br {
            bottom: 12px;
            right: 12px;
        }

        .vfd-screen {
            background: #050505;
            border: 4px solid #111;
            border-radius: 4px;
            border-bottom-color: #222;
            border-right-color: #222;
            box-shadow: inset 0 5px 20px rgba(0, 0, 0, 1);
            position: relative;
            overflow: hidden;
        }

        .vfd-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: linear-gradient(rgba(16, 185, 129, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(16, 185, 129, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: 1;
        }

        .digital-font {
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
        }

        .btn-retro {
            background: linear-gradient(to bottom, #3a3a3a, #222);
            border: 1px solid #000;
            border-top: 1px solid #555;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            color: #aaa;
            text-shadow: 0 -1px 0 #000;
            transition: all 0.1s;
        }

        .btn-retro:active {
            background: #1a1a1a;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.8);
            transform: translateY(1px);
            color: #888;
        }

        .btn-retro-active {
            background: linear-gradient(to bottom, #333, #222);
            color: #10b981;
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.8);
            border-color: #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .theme-btn {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.5);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            position: relative;
        }

        .theme-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
        }

        .theme-btn-wood {
            background: #5d4037;
            border-top: 1px solid #8d6e63;
        }

        .theme-btn-metal {
            background: #b0bec5;
            border-top: 1px solid #eceff1;
        }

        .theme-btn-black {
            background: #212121;
            border-top: 1px solid #424242;
        }

        .theme-btn-pink {
            background: #f06292;
            border-top: 1px solid #f8bbd0;
        }

        .theme-active::after {
            background: #00ff00;
            box-shadow: 0 0 5px #00ff00;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #000;
            border-radius: 0;
            border: 1px solid #333;
            box-shadow: inset 1px 1px 2px #000;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 12px;
            background: linear-gradient(to right, #444, #777, #444);
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 1px 2px 4px rgba(0, 0, 0, 0.8);
            border: 1px solid #111;
            border-radius: 1px;
        }

        #master-volume::-webkit-slider-thumb {
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ddd, #555);
            margin-top: -6px;
        }

        #seek-bar::-webkit-slider-thumb {
            height: 12px;
            width: 6px;
            border-radius: 0;
            margin-top: -3px;
            background: #10b981;
        }

        /* Adjusted Slider Height - FIXED to 135px */
        .slider-vertical-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 135px;
            width: 30px;
            background: #151515;
            border-left: 1px solid #2a2a2a;
            border-right: 1px solid #2a2a2a;
            box-shadow: inset 0 0 15px #000;
        }

        input[type=range].slider-vertical {
            transform: rotate(-90deg);
            width: 135px;
            max-width: none;
        }

        .printed-label {
            font-family: Arial, sans-serif;
            font-weight: bold;
            color: #888;
            text-transform: uppercase;
            font-size: 9px;
            letter-spacing: 0.5px;
        }

        .credit-plate {
            background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            color: #3e2723;
            border: 1px solid #8B4513;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            font-family: 'Kanit', sans-serif;
            font-weight: bold;
            padding: 2px 10px;
            border-radius: 2px;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.4);
            display: inline-block;
            font-size: 10px;
        }

        .faceplate {
            background-color: #1a1a1a;
            border: 1px solid #333;
            box-shadow: inset 0 0 20px #000;
            padding: 16px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
        }

        /* Auto-scaling Container - CENTERED */
        #scaler {
            transform-origin: center center;
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Playlist Styles */
        #playlist-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 10, 0.95);
            z-index: 30;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .playlist-header {
            font-family: 'Orbitron', sans-serif;
            color: #10b981;
            font-size: 12px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .playlist-actions {
            display: flex;
            gap: 4px;
        }

        .playlist-actions button,
        .playlist-actions label {
            margin-left: 2px;
            font-size: 10px;
            padding: 2px 6px;
            border: 1px solid #444;
            border-radius: 2px;
            color: #aaa;
            background: #222;
        }

        .playlist-actions button:hover,
        .playlist-actions label:hover {
            color: #fff;
            border-color: #666;
            background: #333;
        }

        .playlist-list {
            flex: 1;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #888;
        }

        .playlist-item {
            padding: 4px 6px;
            cursor: pointer;
            border-bottom: 1px solid #1a1a1a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: all 0.1s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .playlist-item:hover {
            background: #222;
            color: #ccc;
        }

        .playlist-item.active {
            color: #10b981;
            background: #112d22;
            font-weight: bold;
        }

        .playlist-item.missing-file {
            color: #ef4444;
            font-style: italic;
            opacity: 0.7;
        }

        .track-controls {
            display: none;
            gap: 4px;
        }

        .playlist-item:hover .track-controls,
        .playlist-item.delete-mode .track-controls {
            display: flex;
        }

        .track-btn {
            font-size: 9px;
            padding: 0 4px;
            color: #666;
            background: #000;
            border: 1px solid #333;
            border-radius: 2px;
        }

        .track-btn:hover {
            color: #fff;
            border-color: #555;
        }

        .track-btn-del {
            color: #ef4444;
            border-color: #7f1d1d;
        }

        .track-btn-del:hover {
            background: #7f1d1d;
            color: white;
        }

        .relink-btn {
            background-color: #7f1d1d;
            color: #fca5a5;
            padding: 8px 12px;
            margin-bottom: 8px;
            font-size: 11px;
            font-weight: bold;
            border: 1px solid #ef4444;
            border-radius: 4px;
            text-align: center;
            animation: pulse-border 2s infinite;
        }

        .relink-btn:hover {
            background-color: #991b1b;
            color: white;
        }

        /* Preset Side Buttons */
        .preset-side-panel {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            align-content: center;
        }

        .preset-btn-side {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #888;
            font-size: 9px;
            font-family: 'Kanit', sans-serif;
            border-radius: 4px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.1;
            transition: all 0.1s;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .preset-btn-side:hover {
            background: #252525;
            color: #ccc;
            border-color: #555;
        }

        .preset-btn-side:active {
            background: #111;
            transform: translateY(1px);
        }

        .preset-btn-side.active {
            color: #10b981;
            border-color: #10b981;
            background: #112d22;
            box-shadow: 0 0 5px rgba(16, 185, 129, 0.2);
        }

        /* Custom preset style */
        .preset-btn-side.custom {
            border-color: #854d0e;
            color: #fdba74;
        }

        .preset-btn-side.custom:hover {
            border-color: #fbbf24;
            color: #fff;
        }

        .preset-btn-side.custom.active {
            border-color: #fbbf24;
            color: #fbbf24;
            background: #451a03;
        }

        /* Progress Bar for Long Press */
        .hold-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: #fbbf24;
            width: 0%;
            transition: width 0.1s linear;
        }

        @keyframes pulse-border {
            0% {
                border-color: #ef4444;
            }

            50% {
                border-color: #f87171;
            }

            100% {
                border-color: #ef4444;
            }
        }

        .playlist-list::-webkit-scrollbar,
        .preset-list::-webkit-scrollbar {
            width: 6px;
        }

        .playlist-list::-webkit-scrollbar-thumb,
        .preset-list::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }

        .overflow-x-auto::-webkit-scrollbar-track {
            background: #111;
        }

        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .overflow-x-auto::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body>

    <div id="scaler">
        <div id="casing" class="retro-casing theme-wood">
            <div class="screw tl"></div>
            <div class="screw tr"></div>
            <div class="screw bl"></div>
            <div class="screw br"></div>

            <div class="faceplate h-full">
                <!-- Header -->
                <div
                    class="flex flex-col md:flex-row justify-between items-center mb-4 border-b border-gray-800 pb-2 shrink-0">
                    <h1 class="text-2xl font-bold text-gray-400 digital-font tracking-widest"
                        style="text-shadow: 2px 2px 0 #000;">
                        EQ <span class="text-amber-600 text-sm font-sans tracking-normal font-bold">STEREO 2.0</span>
                    </h1>
                    <div class="flex flex-wrap items-center justify-center gap-3 mt-2 md:mt-0">
                        <div class="flex items-center gap-1 bg-[#111] px-2 py-1 rounded border border-gray-700">
                            <span class="printed-label text-[8px] mr-1">SKIN:</span>
                            <div class="theme-btn theme-btn-wood theme-active" onclick="setTheme('wood')"
                                title="Classic Wood"></div>
                            <div class="theme-btn theme-btn-metal" onclick="setTheme('metal')" title="Brushed Metal">
                            </div>
                            <div class="theme-btn theme-btn-black" onclick="setTheme('black')" title="Matte Black">
                            </div>
                            <div class="theme-btn theme-btn-pink" onclick="setTheme('pink')" title="Retro Pink"></div>
                        </div>
                        <div
                            class="bg-black border border-gray-700 px-3 py-1 rounded-sm shadow-[inset_0_0_10px_#000] flex items-center gap-2">
                            <div class="w-1.5 h-1.5 rounded-full bg-red-600 animate-pulse shadow-[0_0_5px_red]"></div>
                            <span id="track-name"
                                class="text-[10px] text-emerald-500 digital-font truncate max-w-[120px] tracking-wide">NO
                                SIGNAL</span>
                        </div>
                        <a href="https://facebook.com/winayo1" target="_blank" class="credit-link no-drag">
                            <div class="credit-plate">‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ ‡∏≠‡∏≠‡∏î‡∏¥‡πÇ‡∏≠‡πâ</div>
                        </a>
                    </div>
                </div>

                <!-- Unified Content Viewport with FIXED HEIGHT -->
                <div id="content-viewport" class="h-[550px] relative">

                    <!-- 1. EQ Mode -->
                    <div id="eq-mode-content" class="h-full flex flex-col">
                        <!-- Visualizer Area -->
                        <div class="relative w-full h-48 vfd-screen mb-6 group bg-black shrink-0">
                            <canvas id="visualizer" class="w-full h-full relative z-10 opacity-90"></canvas>
                            <div id="start-overlay"
                                class="hidden absolute inset-0 flex flex-col items-center justify-center bg-black/90 z-20">
                            </div>

                            <!-- Playlist Overlay -->
                            <div id="playlist-overlay" class="hidden overlay-panel">
                                <div class="playlist-header">
                                    <span>PLAYLIST <span id="playlist-count">(0)</span></span>
                                    <div class="playlist-actions">
                                        <button onclick="savePlaylist()" title="Save Playlist as .json">üíæ SAVE</button>
                                        <button onclick="document.getElementById('playlist-import').click()"
                                            title="Load Playlist">üìÇ OPEN</button>
                                        <input type="file" id="playlist-import" accept=".json" class="hidden">
                                        <button onclick="document.getElementById('add-audio-upload').click()"
                                            title="Add Music">‚ûï ADD</button>
                                        <input type="file" id="add-audio-upload" accept="audio/*" multiple
                                            class="hidden">
                                    </div>
                                </div>
                                <div id="playlist-container" class="playlist-list flex flex-col">
                                    <div class="p-4 text-center text-gray-600 italic">No files loaded.</div>
                                </div>
                            </div>

                            <!-- Preset Overlay (Not used in this layout, but kept hidden) -->
                            <div id="preset-overlay" class="hidden overlay-panel"></div>
                        </div>

                        <!-- Control Panel -->
                        <div class="bg-[#222] p-3 rounded border border-gray-800 shadow-inner mb-6 shrink-0">
                            <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
                                <div class="flex flex-wrap items-center gap-2 justify-center">
                                    <div class="printed-label mr-1">SOURCE:</div>
                                    <button id="radio-btn"
                                        class="btn-retro px-3 py-1.5 rounded text-[10px] font-bold text-amber-500 border-amber-900">RADIO</button>
                                    <input type="file" id="audio-upload" accept="audio/*" multiple class="hidden">
                                    <input type="file" id="folder-upload" webkitdirectory directory class="hidden">
                                    <button onclick="document.getElementById('folder-upload').click()"
                                        class="btn-retro cursor-pointer px-3 py-1.5 rounded text-[10px] flex items-center gap-1 font-bold text-emerald-400">FOLDER</button>
                                    <label for="audio-upload"
                                        class="btn-retro cursor-pointer px-3 py-1.5 rounded text-[10px] flex items-center gap-1 font-bold">FILE</label>
                                    <button id="demo-btn"
                                        class="btn-retro px-3 py-1.5 rounded text-[10px] font-bold">DEMO</button>
                                    <button id="mic-btn"
                                        class="btn-retro px-3 py-1.5 rounded text-[10px] font-bold">MIC</button>
                                    <button id="tab-btn"
                                        class="btn-retro px-3 py-1.5 rounded text-[10px] font-bold">PC-IN</button>
                                    <audio id="audio-player" class="hidden" crossorigin="anonymous"></audio>
                                </div>
                                <div
                                    class="flex items-center gap-3 bg-[#111] px-3 py-1.5 rounded border border-gray-800">

                                    <button id="list-btn"
                                        class="btn-retro px-2 py-1 rounded text-[10px] font-bold border border-gray-600 text-gray-400 hover:text-white"
                                        title="Toggle Playlist">LIST</button>
                                    <button id="vis-style-btn"
                                        class="btn-retro px-2 py-1 rounded text-[10px] font-bold border border-blue-600/50 text-blue-400 hover:text-white"
                                        title="Change Visual">üìä</button>

                                    <!-- Transport Controls -->
                                    <div class="flex items-center gap-1">
                                        <button id="repeat-btn"
                                            class="btn-retro w-6 h-6 rounded flex items-center justify-center text-[8px] font-bold text-gray-400"
                                            title="Repeat">üîÅ</button>
                                        <button id="prev-btn"
                                            class="btn-retro w-6 h-6 rounded flex items-center justify-center text-[10px] disabled:opacity-50">‚èÆ</button>
                                        <button id="play-btn"
                                            class="w-8 h-8 bg-gradient-to-br from-gray-700 to-black rounded-full border border-gray-600 flex items-center justify-center shadow-lg active:translate-y-0.5 disabled:opacity-50"
                                            disabled>
                                            <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="12"
                                                height="12" viewBox="0 0 24 24" fill="#10b981">
                                                <polygon points="5 3 19 12 5 21 5 3" />
                                            </svg>
                                            <svg id="pause-icon" class="hidden" xmlns="http://www.w3.org/2000/svg"
                                                width="12" height="12" viewBox="0 0 24 24" fill="#fbbf24">
                                                <rect x="6" y="4" width="4" height="16" />
                                                <rect x="14" y="4" width="4" height="16" />
                                            </svg>
                                        </button>
                                        <button id="next-btn"
                                            class="btn-retro w-6 h-6 rounded flex items-center justify-center text-[10px] disabled:opacity-50">‚è≠</button>
                                    </div>

                                    <button id="monitor-btn"
                                        class="btn-retro-active px-2 py-1 rounded text-[9px] font-bold border border-emerald-600/50">EQ
                                        ON</button>

                                    <div class="flex items-center gap-2">
                                        <span class="printed-label">VOL</span>
                                        <input type="range" id="master-volume" min="0" max="1" step="0.01" value="0.5"
                                            class="w-16">
                                    </div>

                                    <button id="safety-btn"
                                        class="btn-retro px-1 py-1 rounded text-[8px] font-bold border border-gray-600 text-gray-500 hover:text-white"
                                        title="Safe">üîí</button>
                                </div>
                            </div>

                            <!-- Seek Bar Row -->
                            <div class="w-full flex items-center gap-2 mt-3 px-2 border-t border-gray-800 pt-2"
                                id="seek-container">
                                <span id="current-time"
                                    class="text-[9px] font-mono text-emerald-500 w-8 text-right">00:00</span>
                                <input type="range" id="seek-bar" min="0" value="0" step="0.1"
                                    class="flex-1 h-1.5 cursor-pointer accent-emerald-500 bg-gray-900 rounded-lg appearance-none">
                                <span id="duration" class="text-[9px] font-mono text-emerald-500 w-8">00:00</span>
                            </div>

                            <div class="flex justify-end mt-2">
                                <button id="reset-eq"
                                    class="text-[9px] text-gray-500 hover:text-red-400 font-mono tracking-wider">[
                                    RESET ALL ]</button>
                            </div>
                        </div>

                        <!-- Bands Section with Side Presets -->
                        <div
                            class="bg-[#111] p-4 rounded border-2 border-[#333] shadow-[inset_0_0_20px_#000] flex flex-1 min-h-0 items-center justify-between gap-4">

                            <!-- LEFT: Standard Presets -->
                            <div class="flex flex-col h-full justify-center">
                                <div class="text-[9px] text-gray-500 font-bold text-center mb-1">STANDARD</div>
                                <div id="left-presets"
                                    class="w-24 grid grid-cols-2 gap-1.5 content-center preset-side-panel">
                                    <!-- JS will populate -->
                                </div>
                            </div>

                            <!-- CENTER: Scale + EQ -->
                            <div class="flex-1 flex items-center justify-center">
                                <!-- Scale labels -->
                                <div class="flex flex-col justify-between items-end mr-3 text-gray-500 text-[9px] font-bold py-2 h-[135px] flex-none"
                                    style="margin-top: -8px;">
                                    <span>+12</span><span>0</span><span>-12</span>
                                </div>
                                <!-- Sliders -->
                                <div class="flex md:grid md:grid-cols-10 gap-1 min-w-max justify-items-center px-1"
                                    id="eq-container"></div>
                            </div>

                            <!-- RIGHT: Custom Presets -->
                            <div class="flex flex-col h-full justify-center">
                                <div class="text-[9px] text-amber-500 font-bold text-center mb-1">CUSTOM (‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
                                </div>
                                <div id="right-presets"
                                    class="w-24 grid grid-cols-2 gap-1.5 content-center preset-side-panel">
                                    <!-- JS will populate -->
                                </div>
                                <!-- Save/Load Buttons -->
                                <div class="flex gap-1 justify-center mt-2">
                                    <button
                                        class="text-[8px] bg-blue-900 text-blue-200 px-2 py-1 rounded border border-blue-700 hover:bg-blue-700 w-full"
                                        onclick="exportCustomPresets()" title="Save Presets to File">SAVE</button>
                                    <button
                                        class="text-[8px] bg-green-900 text-green-200 px-2 py-1 rounded border border-green-700 hover:bg-green-700 w-full"
                                        onclick="document.getElementById('preset-file-import').click()"
                                        title="Load Presets from File">LOAD</button>
                                    <input type="file" id="preset-file-import" accept=".json" class="hidden">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Radio Mode -->
                    <div id="radio-mode-content"
                        class="hidden w-full h-full relative bg-zinc-900 border-2 border-gray-700 rounded overflow-hidden shadow-2xl flex flex-col">
                        <div
                            class="bg-[#111] p-2 flex justify-between items-center z-30 border-b border-gray-600 shrink-0">
                            <div class="flex items-center gap-2">
                                <span
                                    class="text-amber-500 font-bold ml-2 text-sm tracking-wider flex items-center gap-2">
                                    <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span> LUANGTA YOUTUBE
                                </span>
                            </div>
                            <button id="close-radio-btn"
                                class="bg-red-800 hover:bg-red-600 text-white px-3 py-1 rounded text-[10px] font-bold transition border border-red-900">CLOSE
                                RADIO</button>
                        </div>
                        <div class="w-full flex-1 bg-black relative flex items-center justify-center">
                            <iframe id="radio-frame-youtube" class="w-full h-full" src="" title="YouTube video player"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- AUTO-FIT LOGIC ---
        function fitToScreen() {
            const casing = document.getElementById('casing');
            const wrapper = document.getElementById('scaler');
            const casingW = casing.offsetWidth;
            const casingH = casing.offsetHeight;
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            const padding = 20;
            const scaleX = (winW - padding) / casingW;
            const scaleY = (winH - padding) / casingH;
            let scale = Math.min(scaleX, scaleY);
            scale = scale * currentZoom;
            wrapper.style.transform = `scale(${scale})`;
            setTimeout(resizeSliders, 100);
        }
        window.addEventListener('resize', fitToScreen);
        window.addEventListener('load', fitToScreen);
        setTimeout(fitToScreen, 100);

        // --- SETUP UI ---
        const freqs = [31, 63, 125, 250, 500, 1000, 2000, 4000, 8000, 16000];
        const container = document.getElementById('eq-container');
        freqs.forEach((f, index) => {
            const label = f >= 1000 ? (f / 1000) + 'k' : f;
            const color = (f === 1000) ? 'text-emerald-500' : 'text-gray-300';
            const div = document.createElement('div');
            div.className = 'flex flex-col items-center w-14 md:w-auto';
            const extraAttr = (index <= 2) ? `data-safe="true"` : '';
            div.innerHTML = `<div class="slider-vertical-wrapper"><input type="range" class="slider-vertical eq-band" data-freq="${f}" ${extraAttr} min="-12" max="12" value="0" step="0.1"></div><div class="text-center mt-2 border-t border-gray-700 w-full pt-1"><span class="block printed-label ${color}">${label}</span><span class="block text-[7px] text-gray-600 font-mono">Hz</span></div>`;
            container.appendChild(div);
        });

        // DYNAMIC SLIDER RESIZING
        function resizeSliders() {
            const wrappers = document.querySelectorAll('.slider-vertical-wrapper');
            if (wrappers.length === 0) return;
            const wrapper = wrappers[0];
            const availableHeight = wrapper.clientHeight;
            const sliders = document.querySelectorAll('input.slider-vertical');
            sliders.forEach(slider => {
                slider.style.width = availableHeight + 'px';
            });
        }
        window.addEventListener('resize', resizeSliders);

        window.setTheme = function (name) {
            document.getElementById('casing').className = `w-full max-w-6xl retro-casing theme-${name}`;
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('theme-active'));
            const btn = document.querySelector(`.theme-btn-${name}`);
            if (btn) btn.classList.add('theme-active');
            setTimeout(fitToScreen, 50);
        };

        window.windowApi = function (action) {
            if (window.pywebview) {
                if (action === 'close') window.pywebview.api.close_window();
                if (action === 'minimize') window.pywebview.api.minimize_window();
            }
        };

        let currentZoom = 1.0;
        window.adjustZoom = function (delta) {
            let newZoom = currentZoom + delta;
            if (newZoom < 0.2) newZoom = 0.2;
            if (newZoom > 3.0) newZoom = 3.0;
            currentZoom = newZoom;
            fitToScreen();
        };

        let isSafetyLocked = true;
        const SAFETY_VOL_LIMIT = 0.8;
        const SAFETY_EQ_LIMIT = 7.2;

        function toggleSafetyLock() {
            isSafetyLocked = !isSafetyLocked;
            const btn = document.getElementById('safety-btn');
            if (isSafetyLocked) {
                btn.innerHTML = 'üîí';
                btn.classList.remove('text-red-500', 'border-red-500');
                btn.classList.add('text-gray-400', 'border-gray-600');
                enforceSafetyLimits();
            } else {
                btn.innerHTML = 'üîì';
                btn.classList.add('text-red-500', 'border-red-500');
                btn.classList.remove('text-gray-400', 'border-gray-600');
            }
        }

        function enforceSafetyLimits() {
            if (!isSafetyLocked) return;
            const vol = document.getElementById('master-volume');
            if (vol.value > SAFETY_VOL_LIMIT) { vol.value = SAFETY_VOL_LIMIT; if (gainNode) gainNode.gain.value = SAFETY_VOL_LIMIT; }
            const bands = document.querySelectorAll('.eq-band');
            for (let i = 0; i < 3; i++) {
                if (parseFloat(bands[i].value) > SAFETY_EQ_LIMIT) {
                    bands[i].value = SAFETY_EQ_LIMIT;
                    if (filters[i]) filters[i].gain.value = SAFETY_EQ_LIMIT;
                }
            }
        }

        const audioPlayer = document.getElementById('audio-player');
        const eqBands = document.querySelectorAll('.eq-band');
        const canvas = document.getElementById('visualizer');
        const ctx = canvas ? canvas.getContext('2d') : null;
        const demoTrackUrl = 'https://upload.wikimedia.org/wikipedia/commons/transcoded/e/eb/Beethoven_Moonlight_1st_movement.ogg/Beethoven_Moonlight_1st_movement.ogg.mp3';
        const radioUrlLive = 'https://www.youtube.com/embed/sYDotmUeJpQ?si=81bB-2JLgXbxl7oK&autoplay=1';

        let audioContext, gainNode, eqInputNode, splitter, analyserL, analyserR, merger;
        let filters = [], isPlaying = false, animationId;
        let elementSourceNode = null, streamSourceNode = null, isBypass = false;
        let visualizerStyle = 1;
        const isExe = window.pywebview !== undefined;

        // --- PLAYLIST LOGIC ---
        let playlist = [];
        let currentTrackIndex = -1;
        let repeatMode = 0; // 0: Off, 1: All, 2: One
        let pressTimer = null;
        let draggedIndex = -1;

        // --- PRESET LOGIC ---
        const presets = {
            'Normal': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Pop': [2, 3, 4, 3, -1, -1, 1, 2, 3, 3],
            'Rock': [4, 3, 2, 0, -2, -2, 0, 2, 4, 4],
            'Jazz': [3, 2, 1, 2, -2, -2, 0, 1, 3, 4],
            'Classic': [3, 2, 1, 1, 1, 1, 2, 3, 3, 3],
            'Bass+': [6, 5, 4, 2, 0, 0, 0, 0, 0, 0],
            'Treble+': [0, 0, 0, 0, 0, 1, 2, 4, 5, 6],
            'Mid+': [0, 0, -2, 2, 4, 4, 2, -2, 0, 0]
        };
        let customPresets = [];
        const CUSTOM_STORAGE_KEY = 'winai_eq_custom_presets';

        function loadCustomPresets() {
            const saved = localStorage.getItem(CUSTOM_STORAGE_KEY);
            if (saved) {
                try { customPresets = JSON.parse(saved); } catch (e) { customPresets = []; }
            }
            if (customPresets.length !== 8) {
                customPresets = [];
                for (let i = 0; i < 8; i++) {
                    customPresets.push({ name: `User ${i + 1}`, values: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0] });
                }
            }
        }

        function saveCustomPresetsToStorage() {
            localStorage.setItem(CUSTOM_STORAGE_KEY, JSON.stringify(customPresets));
        }

        function exportCustomPresets() {
            const data = JSON.stringify(customPresets);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'winai_eq_custom.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importCustomPresets(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (evt) {
                try {
                    const items = JSON.parse(evt.target.result);
                    if (Array.isArray(items) && items.length === 8) {
                        customPresets = items;
                        saveCustomPresetsToStorage();
                        renderPresetsUI();
                        alert("‡πÇ‡∏´‡∏•‡∏î Custom Presets ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
                    } else {
                        alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 8 Presets)");
                    }
                } catch (err) { alert("‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢"); }
            };
            reader.readAsText(file);
        }

        function renderPresetsUI() {
            const leftContainer = document.getElementById('left-presets');
            const rightContainer = document.getElementById('right-presets');

            leftContainer.innerHTML = '';
            rightContainer.innerHTML = '';

            // Left: Standard Presets
            Object.keys(presets).forEach(name => {
                const btn = document.createElement('button');
                btn.className = 'preset-btn-side';
                btn.textContent = name;
                btn.title = "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î";
                btn.onclick = () => {
                    applyPreset(presets[name]);
                    highlightPreset(btn);
                };
                leftContainer.appendChild(btn);
            });

            // Right: Custom Presets
            customPresets.forEach((p, idx) => {
                const btn = document.createElement('button');
                btn.className = 'preset-btn-side custom';
                btn.textContent = p.name;
                btn.title = "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î / ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";

                // Click to load
                btn.onclick = (e) => {
                    // Prevent click if it was a long press
                    if (e.detail === 0) return; // synthetic click?
                };

                // Long press logic
                let pressTimer;
                let isLongPress = false;

                // Touch Start
                const startPress = (e) => {
                    if (e.type === 'touchstart') e.preventDefault(); // Stop mouse emulation
                    isLongPress = false;

                    const bar = document.createElement('div');
                    bar.className = 'hold-progress';
                    btn.appendChild(bar);
                    // Force reflow
                    void btn.offsetWidth;
                    bar.style.width = '100%';

                    pressTimer = setTimeout(() => {
                        isLongPress = true;
                        const newName = prompt("‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ Preset ‡πÉ‡∏´‡∏°‡πà:", p.name);
                        if (newName) {
                            p.name = newName.substring(0, 8);
                            p.values = getCurrentEQValues();
                            saveCustomPresetsToStorage();
                            btn.textContent = p.name;
                            alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "${p.name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);
                        }
                        if (bar) bar.remove();
                    }, 1000);
                };

                // Touch End / Mouse Up
                const endPress = (e) => {
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                    const bar = btn.querySelector('.hold-progress');
                    if (bar) bar.remove();

                    if (!isLongPress) {
                        // Short press -> Load Preset
                        applyPreset(p.values);
                        highlightPreset(btn);
                    }
                };

                btn.addEventListener('mousedown', startPress);
                btn.addEventListener('touchstart', startPress);

                btn.addEventListener('mouseup', endPress);
                btn.addEventListener('mouseleave', () => {
                    if (pressTimer) clearTimeout(pressTimer);
                    const bar = btn.querySelector('.hold-progress');
                    if (bar) bar.remove();
                });
                btn.addEventListener('touchend', endPress);

                rightContainer.appendChild(btn);
            });
        }

        function highlightPreset(targetBtn) {
            document.querySelectorAll('.preset-btn-side').forEach(b => b.classList.remove('active'));
            targetBtn.classList.add('active');
        }

        function getCurrentEQValues() {
            const bands = document.querySelectorAll('.eq-band');
            const vals = [];
            bands.forEach(b => vals.push(parseFloat(b.value)));
            return vals;
        }

        function applyPreset(values) {
            const bands = document.querySelectorAll('.eq-band');
            bands.forEach((b, i) => {
                if (values[i] !== undefined) {
                    b.value = values[i];
                    b.dispatchEvent(new Event('input'));
                }
            });
        }

        safeAddListener('preset-file-import', 'change', importCustomPresets);

        // Initial Load
        loadCustomPresets();
        renderPresetsUI();

        // --- SEEK BAR LOGIC ---
        const seekBar = document.getElementById('seek-bar');
        const currentTimeDisplay = document.getElementById('current-time');
        const durationDisplay = document.getElementById('duration');

        function formatTime(seconds) {
            if (isNaN(seconds)) return "00:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
        }

        audioPlayer.addEventListener('loadedmetadata', () => {
            if (!streamSourceNode) {
                seekBar.max = audioPlayer.duration;
                durationDisplay.innerText = formatTime(audioPlayer.duration);
                seekBar.disabled = false;
            }
        });

        audioPlayer.addEventListener('timeupdate', () => {
            if (!streamSourceNode) {
                currentTimeDisplay.innerText = formatTime(audioPlayer.currentTime);
                seekBar.value = audioPlayer.currentTime;
            }
        });

        seekBar.addEventListener('input', () => {
            if (audioPlayer.duration) {
                audioPlayer.currentTime = seekBar.value;
            }
        });


        function safeAddListener(id, event, fn) { const el = document.getElementById(id); if (el) el.addEventListener(event, fn); }
        function resizeViz() { if (canvas) { canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight; } }
        window.addEventListener('resize', resizeViz); resizeViz();

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                eqInputNode = audioContext.createGain(); gainNode = audioContext.createGain();
                splitter = audioContext.createChannelSplitter(2); merger = audioContext.createChannelMerger(2);
                analyserL = audioContext.createAnalyser(); analyserL.fftSize = 2048; analyserL.smoothingTimeConstant = 0.8;
                analyserR = audioContext.createAnalyser(); analyserR.fftSize = 2048; analyserR.smoothingTimeConstant = 0.8;
                filters = freqs.map((f, i) => {
                    const filter = audioContext.createBiquadFilter(); filter.frequency.value = f;
                    filter.type = (i === 0) ? 'lowshelf' : (i === freqs.length - 1) ? 'highshelf' : 'peaking';
                    if (filter.type === 'peaking') filter.Q.value = 1.4; filter.gain.value = 0; return filter;
                });
                setupRouting(false);
                gainNode.gain.value = 0.5;
            }
            if (audioContext.state === 'suspended') audioContext.resume();
        }

        function setupRouting(bypass) {
            if (!eqInputNode) return;
            eqInputNode.disconnect(); filters.forEach(f => f.disconnect());
            splitter.disconnect(); analyserL.disconnect(); analyserR.disconnect(); merger.disconnect();
            let eqOut = eqInputNode;
            if (!bypass) { filters.forEach(f => { eqOut.connect(f); eqOut = f; }); updateMonitorUI(true); } else { updateMonitorUI(false); }
            eqOut.connect(splitter); splitter.connect(analyserL, 0); splitter.connect(analyserR, 1);
            analyserL.connect(merger, 0, 0); analyserR.connect(merger, 0, 1);
            merger.connect(gainNode); gainNode.connect(audioContext.destination);
        }

        function updateMonitorUI(isEQ) {
            const btn = document.getElementById('monitor-btn'); if (!btn) return;
            if (isEQ) { btn.classList.add('btn-retro-active'); btn.classList.remove('btn-retro'); btn.innerHTML = '<span class="led-indicator" style="background-color:#00ff00;box-shadow:0 0 5px #00ff00"></span> EQ ON'; }
            else { btn.classList.remove('btn-retro-active'); btn.classList.add('btn-retro'); btn.innerHTML = '<span class="led-indicator" style="background-color:#333;box-shadow:none"></span> RAW'; }
        }

        function visualize() {
            if (!analyserL || !ctx) { requestAnimationFrame(visualize); return; }
            const bufferLen = analyserL.frequencyBinCount;
            const dataL = new Uint8Array(bufferLen); const dataR = new Uint8Array(bufferLen);
            const w = canvas.width; const h = canvas.height;
            function draw() {
                animationId = requestAnimationFrame(draw);
                analyserL.getByteFrequencyData(dataL); analyserR.getByteFrequencyData(dataR);
                ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, h);
                if (visualizerStyle === 0) {
                    const bars = 64; const usefulBins = Math.floor(bufferLen * 0.7); const step = Math.floor(usefulBins / bars); const barW = (w / bars) - 2;
                    for (let i = 0; i < bars; i++) {
                        let sumL = 0, sumR = 0; for (let j = 0; j < step; j++) { sumL += dataL[(i * step) + j]; sumR += dataR[(i * step) + j]; }
                        const hL = (h / 2) * ((sumL / step) / 255); const hR = (h / 2) * ((sumR / step) / 255);
                        ctx.fillStyle = getGradient(h, 0); ctx.fillRect(i * (barW + 2), (h / 2) - hL, barW, hL);
                        ctx.fillStyle = getGradient(h, 1); ctx.fillRect(i * (barW + 2), (h / 2), barW, hR);
                    }
                    ctx.strokeStyle = '#333'; ctx.beginPath(); ctx.moveTo(0, h / 2); ctx.lineTo(w, h / 2); ctx.stroke();
                } else if (visualizerStyle === 1) {
                    const bars = 64; const usefulBins = Math.floor(bufferLen * 0.7); const step = Math.floor(usefulBins / bars); const barW = (w / bars); const centerX = w / 2;
                    for (let i = 0; i < bars; i++) {
                        let sum = 0; for (let j = 0; j < step; j++) sum += (dataL[(i * step) + j] + dataR[(i * step) + j]) / 2;
                        const barH = h * ((sum / step) / 255);
                        const xRight = centerX + (i * barW); const xLeft = centerX - ((i + 1) * barW);
                        ctx.fillStyle = getGradient(h, 0);
                        if (xRight < w) ctx.fillRect(xRight, (h - barH) / 2, barW - 1, barH);
                        if (xLeft >= -barW) ctx.fillRect(xLeft, (h - barH) / 2, barW - 1, barH);
                    }
                } else {
                    analyserL.getByteTimeDomainData(dataL); analyserR.getByteTimeDomainData(dataR); ctx.lineWidth = 2;
                    ctx.strokeStyle = '#10b981'; ctx.beginPath(); let sliceWidth = w * 1.0 / bufferLen; let x = 0;
                    for (let i = 0; i < bufferLen; i++) { let v = dataL[i] / 128.0; let y = v * h / 4 + h / 4; if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); x += sliceWidth; } ctx.stroke();
                    ctx.strokeStyle = '#f59e0b'; ctx.beginPath(); x = 0;
                    for (let i = 0; i < bufferLen; i++) { let v = dataR[i] / 128.0; let y = v * h / 4 + h * 0.75; if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); x += sliceWidth; } ctx.stroke();
                }
            }
            draw();
        }

        function getGradient(h, type) {
            const grad = ctx.createLinearGradient(0, h, 0, 0);
            grad.addColorStop(0, '#22c55e'); grad.addColorStop(0.6, '#eab308'); grad.addColorStop(1, '#ef4444'); return grad;
        }

        function clearActiveModes() {
            document.getElementById('eq-mode-content').classList.remove('hidden');
            document.getElementById('radio-mode-content').classList.add('hidden');
            document.getElementById('radio-frame-youtube').src = "";
            ['mic-btn', 'tab-btn', 'demo-btn', 'radio-btn'].forEach(id => { const b = document.getElementById(id); if (b) { b.classList.remove('btn-retro-active'); b.classList.add('btn-retro'); } });
            if (streamSourceNode) { try { streamSourceNode.disconnect(); } catch (e) { } streamSourceNode = null; }
            if (audioPlayer.srcObject) { audioPlayer.srcObject.getTracks().forEach(t => t.stop()); audioPlayer.srcObject = null; }
            audioPlayer.pause(); audioPlayer.removeAttribute('crossorigin'); audioPlayer.removeAttribute('src');
            if (elementSourceNode) { try { elementSourceNode.disconnect(); } catch (e) { } }
            isBypass = false; setupRouting(false);

            // Disable Seek Bar for non-file modes
            document.getElementById('seek-bar').disabled = true;
            document.getElementById('current-time').innerText = "00:00";
            document.getElementById('duration').innerText = "00:00";
        }

        function loadRadio() {
            clearActiveModes();
            document.getElementById('eq-mode-content').classList.add('hidden');
            document.getElementById('radio-mode-content').classList.remove('hidden');
            document.getElementById('radio-btn').classList.add('btn-retro-active');
            document.getElementById('track-name').textContent = "RADIO MODE";
            document.getElementById('radio-frame-youtube').src = radioUrlLive;
            document.getElementById('track-name').textContent = "LUANGTA DHARMA";
            setTimeout(fitToScreen, 50);
        }

        safeAddListener('close-radio-btn', 'click', () => {
            clearActiveModes();
            document.getElementById('track-name').textContent = "NO SIGNAL";
            setTimeout(fitToScreen, 50);
        });

        safeAddListener('vis-style-btn', 'click', () => {
            visualizerStyle = (visualizerStyle + 1) % 3;
            const styles = ["DUAL BARS", "MIRROR", "WAVEFORM"];
            document.getElementById('track-name').textContent = styles[visualizerStyle];
        });

        safeAddListener('list-btn', 'click', () => {
            const overlay = document.getElementById('playlist-overlay');
            if (overlay.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
                document.getElementById('list-btn').classList.add('btn-retro-active');
                document.getElementById('list-btn').classList.remove('btn-retro');
            } else {
                overlay.classList.add('hidden');
                document.getElementById('list-btn').classList.remove('btn-retro-active');
                document.getElementById('list-btn').classList.add('btn-retro');
            }
        });

        // Playlist Open/Save Handlers
        safeAddListener('playlist-import', 'change', importPlaylist);

        safeAddListener('safety-btn', 'click', toggleSafetyLock);

        function switchToFileMode(isRadio) {
            // clearActiveModes(); // Don't clear mode if we are just changing file in same mode
            // But for safety, let's init
            initAudio();
            document.getElementById('play-btn').disabled = false;
            document.getElementById('seek-bar').disabled = false; // Enable seek
            if (!isRadio) audioPlayer.setAttribute('crossorigin', 'anonymous');
            try { elementSourceNode = audioContext.createMediaElementSource(audioPlayer); elementSourceNode.connect(eqInputNode); } catch (e) { if (elementSourceNode) elementSourceNode.connect(eqInputNode); }
            audioPlayer.muted = false; audioPlayer.volume = 1.0;
        }

        async function startLiveInput(type) {
            try {
                clearActiveModes(); initAudio();
                if (elementSourceNode) { try { elementSourceNode.disconnect(); } catch (e) { } }
                isPlaying = false; updateUI(false); document.getElementById('play-btn').disabled = true;
                let stream;
                if (type === 'mic') {
                    document.getElementById('mic-btn').classList.add('btn-retro-active');
                    document.getElementById('track-name').textContent = "MIC INPUT";
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    alert("‚ö†Ô∏è Use headphones!");
                } else {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) { alert("Not supported"); return; }
                    document.getElementById('tab-btn').classList.add('btn-retro-active');
                    document.getElementById('track-name').textContent = "PC AUDIO";
                    const constraints = { video: { width: 1, height: 1 }, audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false, suppressLocalAudioPlayback: !isExe } };
                    stream = await navigator.mediaDevices.getDisplayMedia(constraints);
                    const v = stream.getVideoTracks()[0]; if (v) { v.stop(); stream.removeTrack(v); }
                }
                streamSourceNode = audioContext.createMediaStreamSource(stream);
                streamSourceNode.connect(eqInputNode);
                audioPlayer.srcObject = stream;
                if (isExe) { audioPlayer.muted = false; audioPlayer.volume = 0.0001; } else { audioPlayer.muted = true; }
                audioPlayer.play().catch(e => { });
                isPlaying = true; updateUI(true);
                stream.getAudioTracks()[0].onended = () => { alert("Disconnected"); if (streamSourceNode) streamSourceNode.disconnect(); isPlaying = false; updateUI(false); clearActiveModes(); };
            } catch (e) { console.error(e); clearActiveModes(); }
        }

        // --- PLAYLIST FUNCTIONS ---
        function loadFiles(files) {
            const isAppend = window.isAppending;
            window.isAppending = false;

            const brokenTracks = playlist.filter(t => t.url === null);
            const isRelinking = brokenTracks.length > 0;

            if (!isAppend && !isRelinking) {
                clearActiveModes();
                playlist = [];
                currentTrackIndex = 0;
            }

            let relinkedCount = 0;
            let addedCount = 0;

            for (let i = 0; i < files.length; i++) {
                if (files[i].type.startsWith('audio/')) {
                    const url = URL.createObjectURL(files[i]);
                    const name = files[i].name;
                    let used = false;

                    if (isRelinking) {
                        const target = playlist.find(t => t.url === null && t.name === name);
                        if (target) {
                            target.url = url;
                            target.className = '';
                            relinkedCount++;
                            used = true;
                        }
                    }

                    if (!used && (!isRelinking || isAppend)) {
                        playlist.push({ name: name, url: url });
                        addedCount++;
                    }
                }
            }

            if (playlist.length > 0) {
                renderPlaylist();
                if (isRelinking) {
                    if (relinkedCount > 0) {
                        alert(`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${relinkedCount} ‡πÄ‡∏û‡∏•‡∏á!`);
                        if (!isPlaying && playlist[currentTrackIndex] && playlist[currentTrackIndex].url) {
                            switchToFileMode(false);
                            playTrack(currentTrackIndex);
                        }
                    } else if (addedCount === 0 && !isAppend) {
                        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ");
                    }
                } else {
                    switchToFileMode(false);
                    if (!isAppend || !isPlaying) playTrack(currentTrackIndex);
                }
                document.getElementById('playlist-overlay').classList.remove('hidden');
                document.getElementById('list-btn').classList.add('btn-retro-active');
            }
        }

        // Wrapper for add button
        safeAddListener('add-audio-upload', 'change', e => {
            window.isAppending = true;
            loadFiles(e.target.files);
        });

        function savePlaylist() {
            const data = JSON.stringify(playlist.map(t => ({ name: t.name })));
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'playlist.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importPlaylist(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (evt) {
                try {
                    const items = JSON.parse(evt.target.result);
                    clearActiveModes();
                    playlist = items.map(i => ({ name: i.name, url: null }));
                    currentTrackIndex = 0;
                    renderPlaylist();
                    document.getElementById('playlist-overlay').classList.remove('hidden');
                    document.getElementById('list-btn').classList.add('btn-retro-active');
                } catch (err) { alert("Invalid playlist file"); }
            };
            reader.readAsText(file);
        }

        function loadDemo() {
            clearActiveModes();
            document.getElementById('demo-btn').classList.add('btn-retro-active');
            playlist = [{ name: "DEMO: MOONLIGHT", url: demoTrackUrl }];
            currentTrackIndex = 0;
            renderPlaylist();
            switchToFileMode(false);
            playTrack(0);
        }

        function renderPlaylist() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = '';
            document.getElementById('playlist-count').textContent = `(${playlist.length})`;

            // Add Relink Button if broken links exist
            const brokenCount = playlist.filter(t => t.url === null).length;
            if (brokenCount > 0) {
                const warnDiv = document.createElement('div');
                warnDiv.className = "relink-btn";
                warnDiv.textContent = `‚ö†Ô∏è ‡∏û‡∏ö ${brokenCount} ‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏•‡∏á`;
                warnDiv.onclick = () => document.getElementById('folder-upload').click();
                container.appendChild(warnDiv);
            }

            playlist.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item ' + (index === currentTrackIndex ? 'active' : '');
                if (track.url === null) item.classList.add('missing-file');

                item.draggable = true;
                item.dataset.index = index;

                item.addEventListener('dragstart', (e) => handleDragStart(e, index));
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', (e) => handleDrop(e, index));
                item.addEventListener('dragend', handleDragEnd);

                item.addEventListener('mousedown', () => handleLongPressStart(index));
                item.addEventListener('mouseup', handleLongPressEnd);
                item.addEventListener('mouseleave', handleLongPressEnd);
                item.addEventListener('touchstart', () => handleLongPressStart(index));
                item.addEventListener('touchend', handleLongPressEnd);

                const nameSpan = document.createElement('span');
                nameSpan.textContent = (index + 1) + ". " + track.name;
                nameSpan.className = "flex-1 overflow-hidden text-ellipsis pointer-events-none";
                item.onclick = () => {
                    if (!item.classList.contains('delete-mode')) {
                        if (track.url) playTrack(index);
                        else document.getElementById('folder-upload').click(); // Suggest finding folder
                    }
                };

                const delBtn = document.createElement('button');
                delBtn.className = "track-btn track-btn-del hidden ml-2";
                delBtn.innerHTML = "DELETE ‚ùå";
                delBtn.onclick = (e) => { e.stopPropagation(); removeTrack(index); };

                item.appendChild(nameSpan);
                item.appendChild(delBtn);
                container.appendChild(item);
            });
        }

        // --- Drag & Drop Reorder ---
        function handleDragStart(e, index) {
            draggedIndex = index;
            e.dataTransfer.effectAllowed = 'move';
            e.target.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }

        function handleDrop(e, targetIndex) {
            e.preventDefault();
            e.stopPropagation();
            if (draggedIndex !== targetIndex && draggedIndex > -1) {
                const movedItem = playlist.splice(draggedIndex, 1)[0];
                playlist.splice(targetIndex, 0, movedItem);

                if (currentTrackIndex === draggedIndex) currentTrackIndex = targetIndex;
                else if (currentTrackIndex > draggedIndex && currentTrackIndex <= targetIndex) currentTrackIndex--;
                else if (currentTrackIndex < draggedIndex && currentTrackIndex >= targetIndex) currentTrackIndex++;

                renderPlaylist();
            }
            return false;
        }

        function handleDragEnd(e) {
            document.querySelectorAll('.playlist-item').forEach(item => {
                item.classList.remove('dragging', 'drag-over');
            });
            draggedIndex = -1;
        }

        // --- Long Press Delete ---
        function handleLongPressStart(index) {
            pressTimer = setTimeout(() => {
                const items = document.querySelectorAll('.playlist-item');
                // Adjust index for warning div offset
                const hasWarning = playlist.some(t => t.url === null);
                // Warning div is first child, so playlist items are +1
                // But querySelectorAll('.playlist-item') gets only items, so index matches
                const targetItem = items[index];
                if (targetItem) {
                    targetItem.classList.add('delete-mode', 'bg-red-900/50');
                    targetItem.querySelector('.track-btn-del').classList.remove('hidden');
                }
            }, 1000);
        }

        function handleLongPressEnd() {
            if (pressTimer) clearTimeout(pressTimer);
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.playlist-item') && !e.target.closest('.track-btn-del')) {
                document.querySelectorAll('.playlist-item').forEach(item => {
                    item.classList.remove('delete-mode', 'bg-red-900/50');
                    const delBtn = item.querySelector('.track-btn-del');
                    if (delBtn) delBtn.classList.add('hidden');
                });
            }
        });

        function removeTrack(index) {
            playlist.splice(index, 1);
            if (index < currentTrackIndex) {
                currentTrackIndex--;
            } else if (index === currentTrackIndex) {
                if (playlist.length > 0) {
                    if (currentTrackIndex >= playlist.length) currentTrackIndex = 0;
                    playTrack(currentTrackIndex);
                } else {
                    audioPlayer.pause();
                    isPlaying = false;
                    updateUI(false);
                    document.getElementById('track-name').textContent = "NO SIGNAL";
                }
            }
            renderPlaylist();
        }

        function playTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            const track = playlist[index];
            if (!track.url) {
                alert("File missing. Please use the Relink button.");
                return;
            }
            currentTrackIndex = index;
            audioPlayer.src = track.url;
            document.getElementById('track-name').textContent = track.name.toUpperCase().substring(0, 20);
            renderPlaylist();
            playAudio();
        }

        function playNext() {
            if (playlist.length === 0) return;
            let nextIndex = currentTrackIndex + 1;
            if (nextIndex >= playlist.length) nextIndex = 0;
            playTrack(nextIndex);
        }

        function playPrev() {
            if (playlist.length === 0) return;
            let prevIndex = currentTrackIndex - 1;
            if (prevIndex < 0) prevIndex = playlist.length - 1;
            playTrack(prevIndex);
        }

        // Repeat Logic
        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3;
            const btn = document.getElementById('repeat-btn');
            const modes = ["üîÅ OFF", "üîÅ ALL", "üîÇ ONE"];
            const titles = ["Repeat Off", "Repeat All", "Repeat One"];
            const colors = ["text-gray-400", "text-emerald-400", "text-amber-400"];

            btn.innerHTML = modes[repeatMode].split(" ")[0];
            btn.title = titles[repeatMode];
            btn.className = `btn-retro w-6 h-6 rounded flex items-center justify-center text-[10px] font-bold ${colors[repeatMode]}`;
        }

        function playAudio() {
            audioPlayer.load();
            const h = () => { togglePlay(true); audioPlayer.removeEventListener('canplay', h); };
            audioPlayer.addEventListener('canplay', h);
        }

        function togglePlay(force) {
            if (streamSourceNode) return;
            const shouldPlay = force !== undefined ? force : audioPlayer.paused;
            if (shouldPlay) { if (audioContext) audioContext.resume(); audioPlayer.play().then(() => { isPlaying = true; updateUI(true); }).catch(() => { isPlaying = false; updateUI(false); }); }
            else { audioPlayer.pause(); isPlaying = false; updateUI(false); }
        }
        function updateUI(p) {
            const play = document.getElementById('play-icon'), pause = document.getElementById('pause-icon');
            if (p) { play.classList.add('hidden'); pause.classList.remove('hidden'); } else { play.classList.remove('hidden'); pause.classList.add('hidden'); }
        }

        safeAddListener('audio-upload', 'change', e => loadFiles(e.target.files));
        safeAddListener('folder-upload', 'change', e => loadFiles(e.target.files));

        safeAddListener('demo-btn', 'click', loadDemo); safeAddListener('demo-btn-overlay', 'click', loadDemo);
        safeAddListener('radio-btn', 'click', loadRadio); safeAddListener('radio-btn-overlay', 'click', loadRadio);
        safeAddListener('mic-btn', 'click', () => startLiveInput('mic')); safeAddListener('mic-btn-overlay', 'click', () => startLiveInput('mic'));
        safeAddListener('tab-btn', 'click', () => startLiveInput('tab')); safeAddListener('tab-btn-overlay', 'click', () => startLiveInput('tab'));
        safeAddListener('play-btn', 'click', () => { if (!audioContext) initAudio(); togglePlay(); });

        safeAddListener('prev-btn', 'click', playPrev);
        safeAddListener('next-btn', 'click', playNext);
        safeAddListener('repeat-btn', 'click', toggleRepeat);

        safeAddListener('master-volume', 'input', e => {
            if (isSafetyLocked && parseFloat(e.target.value) > SAFETY_VOL_LIMIT) { e.target.value = SAFETY_VOL_LIMIT; }
            if (gainNode) gainNode.gain.value = e.target.value;
        });

        safeAddListener('monitor-btn', 'click', () => { isBypass = !isBypass; setupRouting(isBypass); });

        const resetFn = () => { eqBands.forEach((b, i) => { b.value = 0; if (filters[i]) filters[i].gain.value = 0; }); };
        safeAddListener('reset-eq', 'click', resetFn); safeAddListener('reset-eq-mobile', 'click', resetFn);

        eqBands.forEach((b, i) => {
            b.addEventListener('input', () => {
                if (isSafetyLocked && i < 3 && parseFloat(b.value) > SAFETY_EQ_LIMIT) {
                    b.value = SAFETY_EQ_LIMIT;
                }
                if (filters[i]) filters[i].gain.value = parseFloat(b.value);
            });
            b.addEventListener('dblclick', () => { b.value = 0; if (filters[i]) filters[i].gain.value = 0; });
        });

        // Auto Next Track Logic
        audioPlayer.addEventListener('ended', () => {
            if (repeatMode === 2) {
                playTrack(currentTrackIndex);
            } else if (repeatMode === 1) {
                playNext();
            } else {
                if (currentTrackIndex < playlist.length - 1) {
                    playNext();
                } else {
                    isPlaying = false;
                    updateUI(false);
                }
            }
        });

        visualize();
    </script>
</body>

</html>